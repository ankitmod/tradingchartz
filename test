from nsepy import get_history
from datetime import date, timedelta
import pandas as pd

from tradingchartz.src.data_sourcing.nsepy_data import NSEPyData
from tradingchartz.src.backtesting.triple_barrier import triple_barrier_labels, TripleBarrier

end_day = date.today()
start_day = end_day - timedelta(2400)

def nse_stock():
        df = NSEPyData.historical_stock_close_price(symbol='TCS',
                                                    start_date=start_day,
                                                    end_date=end_day)
        return df
# print()

# print(NSEPyData.get_symbol_list('index')['Codes'].to_list())

# print(NSEPyData.get_index_constituents('NIFTY BANK').head().T)

df = nse_stock()

import talib

output = talib.CDL3LINESTRIKE(df.Open, df.High, df.Low, df.Close)
# print(df)
# print(output.head())
output = output[output.values>0]
# output['entry_price'] = df.shift(-1).loc[output.index, 'Open']
print(type(output))

test = output.to_frame(name='signals')
test['entry_price'] = df.shift(-1).loc[output.index, 'Open']
print(df.loc[date(2017, 1, 16), 'Open'])
print(test)

triple_barrier = TripleBarrier(.1, .05, None)
barrier_output = triple_barrier_labels(df, output, triple_barrier)
print(barrier_output.T)



